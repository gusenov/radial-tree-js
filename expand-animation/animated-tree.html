<!DOCTYPE html>
	<head>
		<title></title>
		<meta charset="utf-8" />
		<script type="text/javascript" src="jquery.min.js" ></script>
		<script type="text/javascript"><!--
			var fakeData = {
				"root": 	{
					"id": 0,
					"visible": false,
					"name": "Root",
					"value": 0,
					"childrens": [
						{
						"id": 1,
						"visible": false,
						"name": "model",
						"value": 0,
						"childrens": [
							{
							"id": 2,
							"visible": false,
							"name": "color",
							"value": 0,
							"childrens": [
								{
								"id": 3,
								"visible": false,
								"name": "year",
								"value": 0,
								"childrens": [
								]
								}
				,				{
								"id": 4,
								"visible": false,
								"name": "year",
								"value": 0,
								"childrens": [
								]
								}
							]
							}
				,			{
							"id": 5,
							"visible": false,
							"name": "color",
							"value": 0,
							"childrens": [
								{
								"id": 6,
								"visible": false,
								"name": "year",
								"value": 0,
								"childrens": [
								]
								}
				,				{
								"id": 7,
								"visible": false,
								"name": "year",
								"value": 0,
								"childrens": [
								]
								}
							]
							}
				,			{
							"id": 8,
							"visible": false,
							"name": "color",
							"value": 0,
							"childrens": [
								{
								"id": 9,
								"visible": false,
								"name": "year",
								"value": 0,
								"childrens": [
								]
								}
				,				{
								"id": 10,
								"visible": false,
								"name": "year",
								"value": 0,
								"childrens": [
								]
								}
							]
							}
				,			{
							"id": 11,
							"visible": false,
							"name": "year",
							"value": 0,
							"childrens": [
								{
								"id": 12,
								"visible": false,
								"name": "color",
								"value": 0,
								"childrens": [
								]
								}
				,				{
								"id": 13,
								"visible": false,
								"name": "color",
								"value": 0,
								"childrens": [
								]
								}
				,				{
								"id": 14,
								"visible": false,
								"name": "color",
								"value": 0,
								"childrens": [
								]
								}
							]
							}
				,			{
							"id": 15,
							"visible": false,
							"name": "year",
							"value": 0,
							"childrens": [
								{
								"id": 16,
								"visible": false,
								"name": "color",
								"value": 0,
								"childrens": [
								]
								}
				,				{
								"id": 17,
								"visible": false,
								"name": "color",
								"value": 0,
								"childrens": [
								]
								}
				,				{
								"id": 18,
								"visible": false,
								"name": "color",
								"value": 0,
								"childrens": [
								]
								}
							]
							}
						]
						}
				,		{
						"id": 19,
						"visible": false,
						"name": "color",
						"value": 0,
						"childrens": [
							{
							"id": 20,
							"visible": false,
							"name": "model",
							"value": 0,
							"childrens": [
								{
								"id": 21,
								"visible": false,
								"name": "year",
								"value": 0,
								"childrens": [
								]
								}
				,				{
								"id": 22,
								"visible": false,
								"name": "year",
								"value": 0,
								"childrens": [
								]
								}
							]
							}
				,			{
							"id": 23,
							"visible": false,
							"name": "model",
							"value": 0,
							"childrens": [
								{
								"id": 24,
								"visible": false,
								"name": "year",
								"value": 0,
								"childrens": [
								]
								}
				,				{
								"id": 25,
								"visible": false,
								"name": "year",
								"value": 0,
								"childrens": [
								]
								}
							]
							}
				,			{
							"id": 26,
							"visible": false,
							"name": "year",
							"value": 0,
							"childrens": [
								{
								"id": 27,
								"visible": false,
								"name": "model",
								"value": 0,
								"childrens": [
								]
								}
				,				{
								"id": 28,
								"visible": false,
								"name": "model",
								"value": 0,
								"childrens": [
								]
								}
							]
							}
				,			{
							"id": 29,
							"visible": false,
							"name": "year",
							"value": 0,
							"childrens": [
								{
								"id": 30,
								"visible": false,
								"name": "model",
								"value": 0,
								"childrens": [
								]
								}
				,				{
								"id": 31,
								"visible": false,
								"name": "model",
								"value": 0,
								"childrens": [
								]
								}
							]
							}
						]
						}
				,		{
						"id": 32,
						"visible": false,
						"name": "year",
						"value": 0,
						"childrens": [
							{
							"id": 33,
							"visible": false,
							"name": "model",
							"value": 0,
							"childrens": [
								{
								"id": 34,
								"visible": false,
								"name": "color",
								"value": 0,
								"childrens": [
								]
								}
				,				{
								"id": 35,
								"visible": false,
								"name": "color",
								"value": 0,
								"childrens": [
								]
								}
				,				{
								"id": 36,
								"visible": false,
								"name": "color",
								"value": 0,
								"childrens": [
								]
								}
							]
							}
				,			{
							"id": 37,
							"visible": false,
							"name": "model",
							"value": 0,
							"childrens": [
								{
								"id": 38,
								"visible": false,
								"name": "color",
								"value": 0,
								"childrens": [
								]
								}
				,				{
								"id": 39,
								"visible": false,
								"name": "color",
								"value": 0,
								"childrens": [
								]
								}
				,				{
								"id": 40,
								"visible": false,
								"name": "color",
								"value": 0,
								"childrens": [
								]
								}
							]
							}
				,			{
							"id": 41,
							"visible": false,
							"name": "color",
							"value": 0,
							"childrens": [
								{
								"id": 42,
								"visible": false,
								"name": "model",
								"value": 0,
								"childrens": [
								]
								}
				,				{
								"id": 43,
								"visible": false,
								"name": "model",
								"value": 0,
								"childrens": [
								]
								}
							]
							}
				,			{
							"id": 44,
							"visible": false,
							"name": "color",
							"value": 0,
							"childrens": [
								{
								"id": 45,
								"visible": false,
								"name": "model",
								"value": 0,
								"childrens": [
								]
								}
				,				{
								"id": 46,
								"visible": false,
								"name": "model",
								"value": 0,
								"childrens": [
								]
								}
							]
							}
				,			{
							"id": 47,
							"visible": false,
							"name": "color",
							"value": 0,
							"childrens": [
								{
								"id": 48,
								"visible": false,
								"name": "model",
								"value": 0,
								"childrens": [
								]
								}
				,				{
								"id": 49,
								"visible": false,
								"name": "model",
								"value": 0,
								"childrens": [
								]
								}
							]
							}
						]
						}
					]
					}
			};			
			
			var svgns = 'http://www.w3.org/2000/svg';
			
			var SVGRoot = null;
			var frontCircles = null; // Контейнер для узлов.
			var backLines = null; // Контейнер для связующих линей между узлами.
			var backCircles = null; // Контейнер для уровневых окружностей.			
			
			var data = fakeData; // JSON данные для построения дерева.
			
			var root; // Корневой узел.
			
			function TNode(id) {
				this.id = id;
				this.x = 50;
				this.y = 100;
				this.visual;
				this.animation;
				this.childrens;
				this.visible = false;
				this.toX;
				this.toY;
				
				this.Create = function(target, x, y) {
					this.x = x;
					this.y = y;
					
					this.visual = document.createElementNS(svgns, 'circle');
					this.visual.setAttributeNS(null, 'id', this.id);
					this.visual.setAttributeNS(null, 'cx', this.x);
					this.visual.setAttributeNS(null, 'cy', this.y);
					this.visual.setAttributeNS(null, 'r',  15);
					this.visual.setAttributeNS(null, 'fill',  "#0071bc");
					this.visual.setAttributeNS(null,"fill-opacity", 1);
					this.visual.setAttributeNS(null, 'stroke',  "black");
					this.visual.setAttributeNS(null, 'stroke-width',  3);	
					this.visual.setAttributeNS(null, 'onclick', 'TNode_OnClick_Event(evt)');				
						
					target.appendChild(this.visual);
				}
				
				this.Click = function(event) {	
					this.visible = true;
					SetCoor(root, 1, 0, 360, 0, 0);
				}
				
				this.ChangeCoor = function(x, y) {			
					this.x = x;
					this.y = y;									
					this.visual.setAttributeNS(null, 'cx', this.x);
					this.visual.setAttributeNS(null, 'cy', this.y);	
				}
				
				this.Move = function(x, y) {
					this.animation = document.createElementNS(svgns, 'animateTransform');
					this.animation.setAttributeNS(null, 'attributeName',  "transform");
					this.animation.setAttributeNS(null, 'attributeType',  "XML");
					this.animation.setAttributeNS(null, 'type',  "translate");
					this.animation.setAttributeNS(null, 'dur',  "0.5s");
					this.animation.setAttributeNS(null, 'fill',  "freeze");
					this.animation.setAttributeNS(null, 'begin',  "indefinite");
					this.animation.setAttributeNS(null, 'end',  "indefinite");
					this.animation.setAttributeNS(null, 'from',  '0,0');
					var newx = x - this.x; 
					var newy = y - this.y;
					this.animation.setAttributeNS(null, 'to', newx + ',' + newy);
								
					var oneChild;
					while (this.visual.childNodes.length > 0) {
						oneChild = this.visual.lastChild;
						this.visual.removeChild(oneChild);
					}
									
					this.visual.appendChild(this.animation);
					this.animation.beginElement();					
					
					var self = this // промежуточная перменная
					function fun() {					
						self.ChangeCoor(x, y);
						self.animation.setAttributeNS(null, 'to', '0,0');
						self.animation.beginElement();						
					}
					setTimeout(fun, 1000);
				}
			}
			
			var foundObject;
			var searchID;
			function FindObjectInTreeById(n) {
				if (n.id == searchID)
					foundObject = n;
				if (n.childrens.length > 0) {
					for(var i=0, l = n.childrens.length; i<l; ++i) {
						FindObjectInTreeById(n.childrens[i]);
					}
				}			
			}			
			
			function TNode_OnClick_Event(event) {
				var n = event.target;
				searchID = n.id;
				FindObjectInTreeById(root);
				foundObject.Click();
			}		
						
			function JSON2TNode(json_node, tnode_node) // Клонирование JSON данных в собственный класс TNode.
			{
				tnode_node.childrens = new Array();
				if (json_node.childrens.length > 0) {
					for(var i=0, l = json_node.childrens.length; i<l; ++i) {
						tnode_node.childrens.push(new TNode(json_node.childrens[i].id));						
						JSON2TNode(json_node.childrens[i], tnode_node.childrens[i]);
					}
				}
			}
			
			function VisualLine(x1, y1, x2, y2, id)
			{
				var line = document.createElementNS(svgns, 'line');
				line.setAttributeNS(null, 'id', id);
				line.setAttributeNS(null, 'x1', x1);
				line.setAttributeNS(null, 'y1', y1);
				line.setAttributeNS(null, 'x2', x2);
				line.setAttributeNS(null, 'y2', y2);			
				line.setAttributeNS(null, "style","stroke:#0071bc;stroke-width:2");
				return line;
			};			
			
			function VisualRing(fillColor, fillOpacity, strokeColor, strokeWidth, cx, cy, r, id)
			{
				var dot = document.createElementNS(svgns, 'circle');
				dot.setAttributeNS(null, 'id', id);
				dot.setAttributeNS(null, 'cx', cx);
				dot.setAttributeNS(null, 'cy', cy);
				dot.setAttributeNS(null, 'r',  r);
				dot.setAttributeNS(null, 'fill',  fillColor);
				dot.setAttributeNS(null,"fill-opacity", fillOpacity);
				dot.setAttributeNS(null, 'stroke',  strokeColor);
				dot.setAttributeNS(null, 'stroke-width',  strokeWidth);	
				return dot;
			};			
			
			// Перед вызовом этой рекурсивной функции надо ставить nodeCnt = 0.		
			var nodeCnt = 0;
			function CountNodes(node) {
				nodeCnt++;
				if (node.childrens.length > 0)
					for(var j=0, l = node.childrens.length; j<l; ++j)
						CountNodes(node.childrens[j]);
			}			
			
			function SetCoor(node, D, alpha, beta, px, py) {
				if (node.id == 0 && document.getElementById(node.id) == null) { // Только у корневого узла ID должен равняться 0.
					node.Create(document.getElementById("frontCircles"), 0, 0);
				}					
				
				var teta = alpha;
				var Rd = 70 + (70 * D);        
				
				var ringID = 'ring_' + Rd;
				if (document.getElementById(ringID) == null)
					document.getElementById("backCircles").appendChild(VisualRing("#0071bc", 0, "#0071bc", 1, 0, 0, Rd, ringID));
				
				nodeCnt = 0; CountNodes(node); var k = nodeCnt;

				if (node.childrens.length > 0)
				{			
					for(var i=0, l = node.childrens.length; i<l; ++i)
					{										
						nodeCnt = 0; CountNodes(node.childrens[i]); var lambda = nodeCnt;

						var mu = teta + ((lambda / k) * (beta - alpha));
						var x = Rd * Math.cos( ((teta + mu) / 2) * Math.PI / 180 );
						var y = Rd * Math.sin( ((teta + mu) / 2) * Math.PI / 180 );

						if (document.getElementById(node.childrens[i].id) == null)
						{
							node.childrens[i].Create(document.getElementById("frontCircles"), px, py);
							node.childrens[i].toX = x;
							node.childrens[i].toY = y;
							node.childrens[i].Move(x, y);
						}
						
						var lineID = px + '_' + py + '__' + x + '_' + y;
						if (document.getElementById(lineID) == null)
							document.getElementById("backLines").appendChild(VisualLine(px, py, x, y, lineID));

						if (node.childrens[i].visible == true)
							SetCoor(node.childrens[i], D+1, teta, mu, x, y);
							
						teta = mu;
					}					
				}				
			}				
			
			$(document).ready(function(){
				SVGRoot = document.getElementById("svgelem");
				frontCircles = document.getElementById("frontCircles"); // Контейнер для узлов.
				backLines = document.getElementById("backLines"); // Контейнер для связующих линей между узлами.
				backCircles = document.getElementById("backCircles"); // Контейнер для уровневых окружностей.					
				
				root = new TNode(0);
				JSON2TNode(data.root, root);			
				SetCoor(root, 1, 0, 360, 0, 0);
			});			
		//--></script>
	</head>	
	<body>
		<svg id="svgelem" height="1000" width="1000" xmlns="http://www.w3.org/2000/svg">
			<g transform="translate(512, 384)">
				<g id="backCircles">
				</g>
				<g id="backLines">
				</g>
				<g id="frontCircles">
				</g>
			</g>
		</svg>
	</body>
</html>
		